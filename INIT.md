# 初始配置流程
# 目录

- [硬件检测](#硬件检测及固件烧录)
- [电机试运行](#电机试运行)

## 硬件检测及固件烧录
1. 检测设备供电是否正常，电源地是否短路。
2. 检测是否焊接CAN通信芯片MAX3051，如果已焊接上电BOOT0将默认拉高，自动进入DFU烧录模式。
3. 烧录固件（通过[STM32CubeMxProgrammer](#https://www.stmcu.com.cn/Designresource/detail/software/709549)烧录）, 烧录完成后不要退出。继续修改OB选项卡User Configuration选项下nSWBOOT0前方的勾去掉，点击应用。

## 电机试运行

设备配置通过串口进行，下载[Vofa+](#https://www.vofa.plus/downloads/?v=10/24/2023)进行在线调试

1. USB接入PC，打开Vofa+选中串口、选择串口号启动。
2. 发送文本框发送以下命令测试设备是否工作。
```
VERSION
```
3. 设置默认PID参数，大电流电机采用第一组、伺服电机采用第二组。
```
Group 1:
SETIQPID 0.005 0.1 0 0 12 // 设置 KP KI KD 最小误差 输出限幅  
SETIDPID 0.005 0.1 0 0 12 // 输出限幅极限值 = Vbus * (根号3 / 3)
Group 2:
SETIQPID 0.5 0.1 0 0 12
SETIDPID 0.5 0.1 0 0 12
```

4. 开环运行
```
MODE 0 // 切换到开环模式
SETIQ 3 // 设置Q轴电流3A
SETPAIR 4 // 设置电机极对数
SETSPEED 20 // 设置转速 20 RPM
```

5. 使用RLTEST整定PI(实验性功能)
```
RLTEST 5 24 // 参数1 电机额定电流  参数2 供电电压
```

6. 再次尝试开环运行、Kp尽量大保证电流环带宽、可手动调整PI参数以适应不同电机。直至开环运行顺畅无噪音。

7. 极对数测试
```
MODE 0
SETIQ 3
SETSPEED 0
// 完成后用手拧动电机旋转一圈、计数电机一圈卡顿次数，就是极对数。
```

7. 编码器配置
```
MODE 2 // 1 ABZ编码器  2 板载磁编码器MT6825 3 板载磁编码器MT6835
ENCODECONFIG 16384 // 参数为编码器位数 ， 磁编可忽略或默认16384
ENCODEDIR 1 // 0 正向 1 反向 。 可调整电机相线顺序改变电机实际方向。
SETPAIR 4 // 电机实际极对数，默认4级。 可通过开环测量
```

8. 游戏模式
```
GAME 1 // 进入游戏模式  电机将自动回0点。
SAVE // 保存所有参数，下次上电将自动开启电机并回中（确保电源已接入）。
```

9. 回中PID配置
```
SETWHEELPID 0.0005 0 0.1 0 5 // PI参数根据跟随情况调整
```

10. 速度环配置
```
SETSPEEDPID 0.05 0 0 0 7 // PI参数根据跟随情况调整
WAVE // 打印电机数据、须切换到JustFloat模式。
// 通道0-2为三项电流数据 
// 通道3-5为D轴 目标电流 实际电流 输出电压。
// 通道6-8为Q轴 目标电流 实际电流 输出电压。
// 通道9为绝对电角度值 rad.
// 通道10为目标位置
// 通道11为转速 转/秒
// 通道12为供电电压
// 通道13为Mosfet温度
// 通道14为瞬时有功功率
```

11. 位置环配置
```
SETPOSPID 0.5 0 0 0 1500 // PI参数根据跟随情况调整
```

